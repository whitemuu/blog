#+TITLE: è®¾ç½®å¯†é’¥ç™»å½• SSH
#+AUTHOR: angus zhang
#+DATE: 2019-02-18T14:20:49CST
#+TAGS: SSH cryptography how-to linux

* éå¯¹ç§°åŠ å¯†

å…ˆæä¸€ä¸‹å‘éŸ³é—®é¢˜ï¼Œè¯å…¸ç»™çš„å‘éŸ³æ˜¯å¯†é’¥(yue)ï¼Œä¸è¿‡å¤§å¤šæ•°äººè¯»çš„éƒ½æ˜¯å¯†é’¥(yao)ï¼Œè¯­è¨€å°±æ˜¯è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Œå½“å¤šæ•°äººéƒ½é”™äº†çš„æ—¶å€™ï¼Œå°±è¯¥æ”¹æ”¹è§„åˆ™äº†ã€‚æ‰€ä»¥å¤§èƒ†çš„ç»§ç»­è¯»å¯†é’¥(yao)å§ã€‚é¡ºä¾¿ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†åˆ¶éšœçœ‹åˆ°çš„æ˜æ˜æ˜¯'å¯†é’¥'ï¼Œå´ä¸è‡ªè§‰å‘å‡º'å¯†åŒ™'çš„è¯»éŸ³ğŸ™„ã€‚

#+BEGIN_EXAMPLE
          key1              key2
           â†“ encrypt         â†“ decrypt
message ------> gibberish ------> message
#+END_EXAMPLE

ä¸¤ä¸ªkeyï¼Œkey1 åŠ å¯†çš„ä¿¡æ¯åªæœ‰ key2 èƒ½è§£å¯†ï¼Œåè¿‡æ¥ key2 åŠ å¯†çš„ä¿¡æ¯ä¹Ÿä»…æœ‰ key1 èƒ½è§£å¯†ã€‚å³éå¯¹ç§°åŠ å¯†ã€‚

å¦‚æœæˆ‘æŠŠ key2 å…¬å¼€ï¼Œåˆ†å‘ç»™éœ€è¦éªŒè¯æˆ‘çš„äººï¼Œé‚£ä¹ˆæˆ‘å‘é€ä¸€æ®µç» key1 åŠ å¯†è¿‡çš„ä¿¡æ¯ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹å¦‚æœèƒ½å¤Ÿç”¨ key2 è§£å¯†å‡ºæ­£ç¡®çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®š è¯¥ä¿¡æ¯å¿…ç„¶ç”± key1 åŠ å¯†ï¼Œè€Œåªæœ‰æˆ‘æ‰‹é‡Œæœ‰ key1ï¼Œé‚£ä¹ˆå¯ä»¥æ–­å®šä¸€å®šæ˜¯æˆ‘å‘é€çš„ä¿¡æ¯ï¼Œç±æ­¤å®Œæˆèº«ä»½éªŒè¯ã€‚è¿™å°±æ˜¯ =Public key authentication= ã€‚

* æœ‰è¿™ä¸ªå¿…è¦å—ï¼Ÿ

è®¾ç½®å¯†é’¥ç™»å½•çš„æ„ä¹‰ç»ä¸ä»…ä»…æ˜¯å›¾ç™»å½•å…è¾“å…¥å¯†ç è€Œå·²ï¼Œæ›´æ˜¯ä¸ºäº†å®‰å…¨ã€‚

#+BEGIN_EXAMPLE
Last failed login: Mon Jun  6 02:45:00 UTC 2016 from 116.31.116.50 on ssh:notty
There were 17905 failed login attempts since the last successful login.
Last login: Sat Jun  4 10:49:32 2016 from *.*.*.*
-bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory
#+END_EXAMPLE

è¿™æ˜¯æˆ‘ 2016 å¹´æ‰€ä½¿ç”¨çš„ Vultr VPSï¼Œç»å†äº†è‡³å°‘ä¸¤æ¬¡è¿™æ ·çš„æš´åŠ›ç ´è§£ã€‚å½“ç„¶æˆ‘é‡åˆ°çš„ç»éä¸ªä¾‹ [[https://serverfault.com/questions/244614/is-it-normal-to-get-hundreds-of-break-in-attempts-per-day][linux - Is it normal to get hundreds of break-in attempts per day? - Server Fault]]

äº‹å®ä¸Šè¿™è¿˜ä¸æ˜¯ä¸ªåæ¶ˆæ¯ï¼Œå› ä¸ºè¿™è¯´æ˜äº†æˆ‘çš„ä¸»æœºæ˜¯å®‰å…¨çš„ï¼Œå¦‚æœçœŸçš„ç ´è§£æˆåŠŸçš„è¯ï¼Œå¯¹æ–¹å°±ä¸ä¼šè®©ä½ çœ‹åˆ°è¿™äº›ä¸œè¥¿äº†ã€‚
* æ­¥éª¤
** åœ¨æœ¬æœºç”Ÿæˆå¯†é’¥

#+BEGIN_SRC bash
$ ssh-keygen -t rsa
# ssh-keygen generates, manages and converts authentication keys for ssh(1).
#                                                           -- ssh-keygen(1)
#+END_SRC

æœŸé—´ä¼šè¯¢é—®å­˜å‚¨è·¯å¾„å’Œpassphraseï¼ŒæŒ‰ enter ä½¿ç”¨é»˜è®¤å³å¯

ä¹‹åä¼šç”Ÿæˆå¦‚ä¸‹ä¸¤ä¸ªbase64ç¼–ç çš„çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œâš ï¸ç§é’¥è¯·å¦¥å–„ä¿ç®¡ï¼š
- =~/.ssh/id_rsa= :: ç§é’¥
- =~/.ssh/id_rsa.pub= :: å…¬é’¥

** å®‰è£…å…¬é’¥åˆ°æœåŠ¡å™¨

å³å°†å…¬é’¥æ‹·è´åˆ°æœåŠ¡å™¨ =~/.ssh/authorized_keys= ä¸­ï¼Œæ³¨æ„è¿™ä¸ªå¤æ•°çš„æ–‡ä»¶åï¼Œæ˜¯å¯ä»¥æ”¾ç½®å¤šä¸ªå…¬é’¥æ¥ authenticate å¤šä¸ªè¿œç¨‹æœºå™¨çš„ã€‚

å¦‚æœæœåŠ¡å™¨åªæœ‰ä½ ä¸€ä¸ªäººä½¿ç”¨å¯ç›´æ¥
#+BEGIN_SRC bash
$ scp ~/.ssh/id_rsa.pub john-doe@xxx.xxx.xxx.xxx:~/.ssh/authorized_keys
#+END_SRC

æˆ–è€…linuxç”¨æˆ·å¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤
#+BEGIN_SRC bash
$ ssh-copy-id {targethost}
#+END_SRC

å…¶å®ƒæƒ…å†µè¯·å¯†ç  ssh ç™»å½•æ‰‹åŠ¨æ‹·è´ã€‚

** sshd é…ç½®

å½“ç„¶é…ç½®å¥½ä¹‹åè¿˜è¦ç¦ç”¨å¯†ç ç™»é™†ï¼Œå¦åˆ™å¯†é’¥ç™»å½•çš„æ„ä¹‰å°±æ­¢äºæ–¹ä¾¿è€Œå·²ã€‚sshd é…ç½®æ–‡ä»¶
æ˜¯ ~/etc/ssh/sshd_config~

#+BEGIN_EXAMPLE conf
PubkeyAuthentication yes
AuthorizedKeyFile  .ssh/authorized_keys
PasswordAuthentication no  #âš ï¸è¯·ç¡®ä¿å¯†é’¥ç™»å½•æ­£å¸¸å·¥ä½œå†ç¦ç”¨è¯¥æ¡å³å¯†ç ç™»å½•ï¼ï¼
ChallengeResponseAuthentication no
#+END_EXAMPLE

é‡å¯ sshd
#+BEGIN_SRC bash
$ service sshd restart
#+END_SRC

all done!
** debug

å¦‚å¯†é’¥ç™»å½•å¤±è´¥è¯·ç”¨å¦‚ä¸‹æŠ€å·§debug(éœ€rootç”¨æˆ·):

root èº«ä»½å¯†ç (å¸Œæœ›ä½ æ²¡ç¦ç”¨å¯†ç ç™»å½•) ssh åˆ°è¿œç¨‹ä¸»æœºã€‚
#+BEGIN_SRC bash
$ /usr/sbin/sshd -d -p 2222
#+END_SRC

-d è¡¨ç¤º debug mdoe

ç„¶åä»æœ¬æœºè¿æ¥è¯¥ sshd
#+BEGIN_SRC bash
$ ssh -p 2222 user@host
#+END_SRC

è¿œç¨‹ä¸»æœºå³ä¼šæä¾› debug ä¿¡æ¯ã€‚

source: [[https://unix.stackexchange.com/questions/36540/why-am-i-still-getting-a-password-prompt-with-ssh-with-public-key-authentication][Why am I still getting a password prompt with ssh with public key authentication? - Unix & Linux Stack Exchange]]
* ç®¡ç†å¤šä¸ªå¯†é’¥

[[https://superuser.com/questions/586890/can-i-have-more-than-1-private-key-in-ssh][linux - Can I have more than 1 private key in ~/.ssh? - Super User]]
# * Public key fingerprint

# [[https://en.wikipedia.org/wiki/Public_key_fingerprint][Public key fingerprint - Wikipedia]]
# [[https://stackoverflow.com/questions/9607295/how-do-i-find-my-rsa-key-fingerprint][ssh - How do I find my RSA key fingerprint? - Stack Overflow]]
* ref

1) [[https://www.cyberciti.biz/tips/ssh-public-key-based-authentication-how-to.html][SSH Public Key Based Authentication on a Linux/Unix server - nixCraft]]
2) =man 1 ssh-keygen=
3) [[https://www.vultr.com/docs/how-do-i-generate-ssh-keys][How Do I Generate SSH Keys? - Vultr.com]]
4) [[https://help.github.com/articles/connecting-to-github-with-ssh/][Connecting to GitHub with SSH - User Documentation]]
5) [[https://gist.github.com/jexchan/2351996][Multiple SSH keys for different github accounts]]
6) [[http://www.runoob.com/w3cnote/set-ssh-login-key.html][è®¾ç½® SSH é€šè¿‡å¯†é’¥ç™»å½• | èœé¸Ÿæ•™ç¨‹]]
